#+TITLE: The Driver For Redis Written by Pony Language
#+AUTHOR: Titan
#+EMAIL: howay.tan@gmail.com
#+DATE: <2019-06-07 Fri>
#+KEYWORDS: pony redis driver
#+OPTIONS: H:4 toc:t
#+STARTUP: indent
#+SUBTITLE:
#+titlepage: true
#+titlepage-color: 06386e
#+titlepage-text-color: FFFFFF
#+titlepage-rule-color: FFFFFF
#+titlepage-rule-height: 1

* 基本框架
#+begin_src ponylang :tangle ${BUILDDIR}/${NAME}.pony
  use "collections"
  use "net"
  use "promises"
  use "logger"

  <<type>>

  <<lexer-guard-delegate>>

  <<lexer-action-delegate>>

  <<syntax-action-delegate>>

  <<utilities>>

  <<api>>

  <<actor>>
#+end_src
* 类型定义
#+begin_src ponylang :noweb-ref type
  type RedisString is String

  type RedisInteger is I64

  class val RedisError is Stringable
      let _inner: String
      new val create(e: String) => _inner = e
      fun box string() : String iso^ => _inner.clone()

  class val RedisBulkString is Stringable
      let _inner: (String | None)
      new val create(bs: (String | None)) => _inner = bs
      fun is_none(): Bool =>
          match _inner
          | None => true
          else
              false
          end
      fun box string() : String iso^ =>
          match _inner
          | let s: String => s.clone()
          | None => "None".clone()
          end

  class val _RedisArray is ReadSeq[RedisValue]
      embed _inner: Array[RedisValue] = Array[RedisValue]
      fun size(): USize => _inner.size()
      fun apply(i: USize): RedisValue? => _inner(i)?
      fun values(): Iterator[RedisValue] => _inner.values()
      fun ref push(value: RedisValue) : None => _inner.push(value)

  type RedisArray is (_RedisArray | None)

  type RedisValue is (RedisString | RedisError | RedisInteger | RedisBulkString | RedisArray)

  <<syntax-context>>

  <<lexer-context>>
#+end_src
* 协议解析
** BNF 定义
#+begin_src text
  RedisValue = RedisString
             | RedisError
             | RedisInt
             | RedisBulkString
             | RedisEmptyBulkString
             | RedisNullBulkString
             | RedisArray
             | RedisNullArray

  RedisString = "+" string "\r\n"

  RedisError = "-" string "\r\n"

  RedisInt = ":" number "\r\n"

  RedisBulkString = "$" number "\r\n" string "\r\n"

  RedisEmptyBulkString = "$" "0" "\r\n" "\r\n"

  RedisNullBulkString = "$" "-1" "\r\n"

  RedisArray = "*" number "\r\n" RedisArrayItems

  RedisNullArray = "*" "-1" "\r\n"

  RedisArrayItems = RedisArrayItems RedisString
                  | RedisArrayItems RedisError
                  | RedisArrayItems RedisInt
                  | RedisArrayItems RedisBulkString
                  | RedisArrayItems RedisEmptyBulkString
                  | RedisArrayItems RedisNullBulkString
                  | RedisArrayItems RedisArray
                  | RedisArrayItems RedisNullArray
                  | RedisString
                  | RedisError
                  | RedisInt
                  | RedisBulkString
                  | RedisEmptyBulkString
                  | RedisNullBulkString
                  | RedisArray
                  | RedisNullArray
#+end_src
** 词法解析状态机
*** 定义
#+begin_src text :tangle ${BUILDDIR}/lexer.txt
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  | state\event           | input(ch: char)[ch == '+'] | input(ch: char)[ch == '-'] | input(ch: char)[ch == ':'] | input(ch: char)[ch == '$'] | input(ch: char)[ch == '*'] | input(ch: char)[isnumber(ch)] | input(ch: char)[cr_and_strlen_equals_len(ch)] | input(ch: char)[lf_and_strlen_equals_negative_1(ch)] | input(ch: char)[ch == '\r'] | input(ch: char)[ch == '\n'] | input(ch: char)       | eof    |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       | plus                       |                            | colon                      | dollar                     | asterisk                   | add to number(ch)             |                                               |                                                      |                             |                             | add to string(ch)     |        |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          |                                               |                                                      |                             |                             | ----                  |        |
  | INIT                  | +                          | -                          |                            | $                          |                            | NUMBER                        |                                               |                                                      |                             |                             | STRING                |        |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       | minus                      |                            | minus                      | minus                      | minus                      | add minus to number           |                                               |                                                      |                             |                             |                       |        |
  |                       | plus                       | minus                      | colon                      | dollar                     | asterisk                   | add to number(ch)             | minus                                         |                                                      | minus                       |                             | add to string(ch)     |        |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                                          |                                                      | ----                        |                             | ----                  |        |
  | -                     | INIT                       |                            | INIT                       | INIT                       | INIT                       | NUMBER                        | CR                                            |                                                      | CR                          |                             | - STRING              |        |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       | move number to string      | move number to string      | move number to string      | move number to string      | move number to string      |                               |                                               |                                                      |                             |                             | move number to string |        |
  |                       | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to number(ch)             | number                                        |                                                      | number                      |                             | add to string(ch)     | number |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                                          |                                                      | ----                        |                             | ----                  | ----   |
  | NUMBER                | STRING                     | STRING                     | STRING                     | STRING                     | STRING                     |                               | CR                                            |                                                      | CR                          |                             | STRING                | INIT   |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)             | string                                        |                                                      | string                      |                             | add to string(ch)     | string |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                                          |                                                      | ----                        |                             | ----                  | ----   |
  | STRING                |                            |                            |                            |                            |                            |                               | CR                                            |                                                      | CR                          |                             |                       | INIT   |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            |                            |                            |                            |                            |                               |                                               | crlf                                                 |                             | crlf                        |                       | crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                                               | ----                                                 |                             | ----                        |                       | ----   |
  | CR                    |                            |                            |                            |                            |                            |                               |                                               | INIT                                                 |                             | INIT                        |                       | INIT   |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            |                            |                            |                            |                            | add to string(ch)             |                                               |                                                      |                             |                             | add to string(ch)     |        |
  |                       |                            |                            |                            |                            |                            | ----                          |                                               |                                                      |                             |                             | ----                  |        |
  | +                     |                            |                            |                            |                            |                            | + STRING                      |                                               |                                                      |                             |                             | + STRING              |        |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)             | string                                        |                                                      | string                      |                             | add to string(ch)     |        |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                                          |                                                      | ----                        |                             | ----                  |        |
  | + STRING              |                            |                            |                            |                            |                            |                               | + STRING CR                                   |                                                      | + STRING CR                 |                             |                       |        |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            |                            |                            |                            |                            |                               |                                               | crlf                                                 |                             | crlf                        |                       | crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                                               | ----                                                 |                             | ----                        |                       | ----   |
  | + STRING CR           |                            |                            |                            |                            |                            |                               |                                               | INIT                                                 |                             | INIT                        |                       | INIT   |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)             | string                                        |                                                      | string                      |                             | add to string(ch)     |        |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                                          |                                                      | ----                        |                             | ----                  |        |
  | - STRING              |                            |                            |                            |                            |                            |                               | - STRING CR                                   |                                                      | - STRING CR                 |                             |                       |        |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            |                            |                            |                            |                            |                               |                                               | crlf                                                 |                             | crlf                        |                       | crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                                               | ----                                                 |                             | ----                        |                       | ----   |
  | - STRING CR           |                            |                            |                            |                            |                            |                               |                                               | INIT                                                 |                             | INIT                        |                       | INIT   |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            | add to number(ch)          |                            |                            |                            | add to number(ch)             |                                               |                                                      |                             |                             |                       |        |
  |                       |                            | ----                       |                            |                            |                            | ----                          |                                               |                                                      |                             |                             |                       |        |
  | $                     |                            | $ NUMBER                   |                            |                            |                            | $ NUMBER                      |                                               |                                                      |                             |                             |                       |        |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            |                            |                            |                            |                            |                               | set string length                             |                                                      | set string length           |                             |                       |        |
  |                       |                            |                            |                            |                            |                            | add to number(ch)             | number                                        |                                                      | number                      |                             |                       |        |
  |                       |                            |                            |                            |                            |                            | ----                          | ----                                          |                                                      | ----                        |                             |                       |        |
  | $ NUMBER              |                            |                            |                            |                            |                            |                               | $ NUMBER CR                                   |                                                      | $ NUMBER CR                 |                             |                       |        |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            |                            |                            |                            |                            |                               |                                               | crlf                                                 |                             | crlf                        |                       | crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                                               | ----                                                 |                             | ----                        |                       | ----   |
  | $ NUMBER CR           |                            |                            |                            |                            |                            |                               |                                               | INIT                                                 |                             | $ NUMBER CR STRING          |                       | INIT   |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            |                            |                            |                            |                            |                               | string                                        |                                                      |                             |                             |                       |        |
  |                       | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)          | add to string(ch)             | clear string length                           |                                                      | add to string(ch)           | add to string(ch)           | add to string(ch)     |        |
  |                       | ----                       | ----                       | ----                       | ----                       | ----                       | ----                          | ----                                          |                                                      | ----                        | ----                        | ----                  |        |
  | $ NUMBER CR STRING    |                            |                            |                            |                            |                            |                               | $ NUMBER CR STRING CR                         |                                                      |                             |                             |                       |        |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
  |                       |                            |                            |                            |                            |                            |                               |                                               | crlf                                                 |                             | crlf                        |                       | crlf   |
  |                       |                            |                            |                            |                            |                            |                               |                                               | ----                                                 |                             | ----                        |                       | ----   |
  | $ NUMBER CR STRING CR |                            |                            |                            |                            |                            |                               |                                               | INIT                                                 |                             | INIT                        |                       | INIT   |
  +-----------------------+----------------------------+----------------------------+----------------------------+----------------------------+----------------------------+-------------------------------+-----------------------------------------------+------------------------------------------------------+-----------------------------+-----------------------------+-----------------------+--------+
#+end_src
*** 数据定义
#+begin_src ponylang :noweb-ref lexer-context
  class LexerContext
      var num: String
      var str: String
      var strlen: I32
      let sfsm: SyntaxStateMachine[SyntaxContext]
      var sctx: SyntaxContext
      let logger: (Logger[String] | None)

      new create(sfsm': SyntaxStateMachine[SyntaxContext], sctx': SyntaxContext, logger': (Logger[String] | None) = None) =>
          let num': String trn = recover String end
          num = consume num'
          str = recover String() end
          strlen = 0
          sfsm = sfsm'
          sctx = sctx'
          logger = logger'
#+end_src
*** 动作代理
#+begin_src ponylang :noweb-ref lexer-action-delegate
  primitive RedisLexerActionDelegate is LexerActionDelegate[LexerContext]
      fun _feed_event(ctx: LexerContext, value: SyntaxValue) =>
          match value
          | let v: RedisValue =>
              ctx.sctx.input = v
              match v
              | let s: RedisString => ctx.sctx = ctx.sfsm.redisstring(ctx.sctx)
              | let e: RedisError => ctx.sctx = ctx.sfsm.rediserror(ctx.sctx)
              | let i: RedisInteger => ctx.sctx = ctx.sfsm.redisint(ctx.sctx)
              | let b: RedisBulkString =>
                  if b.is_none() then
                      ctx.sctx = ctx.sfsm.redisnullbulkstring(ctx.sctx)
                  else
                      if b.string().size() == 0 then
                          ctx.sctx = ctx.sfsm.redisemptybulkstring(ctx.sctx)
                      else
                          ctx.sctx = ctx.sfsm.redisbulkstring(ctx.sctx)
                      end
                  end
              | let a: RedisArray =>
                  match a
                  | None => ctx.sctx = ctx.sfsm.redisnullarray(ctx.sctx)
                  | let aa: _RedisArray => ctx.sctx = ctx.sfsm.redisarray(ctx.sctx)
                  end
              end
          | let a: List[RedisValue] =>
              let arrlen = ctx.sctx.arrlen.size()
              if arrlen > 0 then
                  ctx.sctx.input = a
                  let last = try ctx.sctx.arrlen(arrlen - 1)? else 0 end
                  if a.size() == last then
                      ctx.sctx = ctx.sfsm.redisarrayitems_where_len_equals_number(ctx.sctx)
                  else
                      ctx.sctx = ctx.sfsm.redisarrayitems_but_len_less_than_number(ctx.sctx)
                  end
              end
          end

      fun _consume_queue(ctx: LexerContext) =>
          while ctx.sctx.queue.size() > 0 do
              try
                  let item = ctx.sctx.queue.shift()?
                  _feed_event(ctx, item)
              else
                  break
              end
          end

      fun plus(ctx: LexerContext): LexerContext =>
          _consume_queue(ctx)
          ctx.sctx.input = "+"
          ctx.sctx = ctx.sfsm.plus(ctx.sctx)
          _consume_queue(ctx)
          ctx

      fun colon(ctx: LexerContext): LexerContext =>
          _consume_queue(ctx)
          ctx.sctx.input = ":"
          ctx.sctx = ctx.sfsm.colon(ctx.sctx)
          _consume_queue(ctx)
          ctx

      fun dollar(ctx: LexerContext): LexerContext =>
          _consume_queue(ctx)
          ctx.sctx.input = "$"
          ctx.sctx = ctx.sfsm.dollar(ctx.sctx)
          _consume_queue(ctx)
          ctx

      fun asterisk(ctx: LexerContext): LexerContext =>
          _consume_queue(ctx)
          ctx.sctx.input = "*"
          ctx.sctx = ctx.sfsm.asterisk(ctx.sctx)
          _consume_queue(ctx)
          ctx

      fun add_to_number(ctx: LexerContext, a0: U8): LexerContext =>
          ctx.num = ctx.num.add(String.from_array([a0]))
          ctx

      fun add_to_string(ctx: LexerContext, a0: U8): LexerContext =>
          ctx.str = ctx.str.add(String.from_array([a0]))
          ctx

      fun minus(ctx: LexerContext): LexerContext =>
          _consume_queue(ctx)
          ctx.sctx.input = "-"
          ctx.sctx = ctx.sfsm.minus(ctx.sctx)
          _consume_queue(ctx)
          ctx

      fun add_minus_to_number(ctx: LexerContext): LexerContext =>
          ctx.num = ctx.num.add("-")
          ctx

      fun move_number_to_string(ctx: LexerContext): LexerContext =>
          ctx.str = ctx.num.clone()
          ctx

      fun number(ctx: LexerContext): LexerContext =>
          let num = try ctx.num.i32()? else 0 end
          if num == 0 then
              _consume_queue(ctx)
              ctx.sctx.input = num
              ctx.sctx = ctx.sfsm.number_0(ctx.sctx)
              ctx.num = ""
              _consume_queue(ctx)
              ctx
          elseif num == -1 then
              _consume_queue(ctx)
              ctx.sctx.input = num
              ctx.sctx = ctx.sfsm.minus1(ctx.sctx)
              ctx.num = ""
              _consume_queue(ctx)
              ctx
          else
              _consume_queue(ctx)
              ctx.sctx.input = num
              ctx.sctx = ctx.sfsm.number(ctx.sctx)
              ctx.num = ""
              _consume_queue(ctx)
              ctx
          end

      fun string(ctx: LexerContext): LexerContext =>
          _consume_queue(ctx)
          ctx.sctx.input = ctx.str
          ctx.sctx = ctx.sfsm.string(ctx.sctx)
          ctx.str = ""
          _consume_queue(ctx)
          ctx

      fun crlf(ctx: LexerContext): LexerContext =>
          _consume_queue(ctx)
          ctx.sctx.input = "\r\n"
          ctx.sctx = ctx.sfsm.crlf(ctx.sctx)
          _consume_queue(ctx)
          ctx

      fun set_string_length(ctx: LexerContext): LexerContext =>
          ctx.strlen = try ctx.num.i32()? else 0 end
          ctx

      fun clear_string_length(ctx: LexerContext): LexerContext =>
          ctx.strlen = 0
          ctx
#+end_src
*** 条件代理
#+begin_src ponylang :noweb-ref lexer-guard-delegate
  primitive RedisLexerGuardDelegate is LexerGuardDelegate[LexerContext]
      fun isnumber(ctx: LexerContext, a0: U8): Bool =>
          if (a0 >= 0x30) and (a0 <= 0x39) then
              true
          else
              false
          end

      fun cr_and_strlen_equals_len(ctx: LexerContext, a0: U8): Bool =>
          if (a0 == 0x0d) and (USize.from[I32](ctx.strlen) == ctx.str.size()) then
              true
          else
              false
          end

      fun lf_and_strlen_equals_negative_1(ctx: LexerContext, a0: U8): Bool =>
          if (a0 == 0x0a) and (ctx.strlen == -1) then
              true
          else
              false
          end
#+end_src
** 语法解析状态机
*** 定义
#+begin_src text :tangle ${BUILDDIR}/syntax.txt
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  | state\event                                               | RedisString                   | RedisError                    | RedisInt                      | RedisBulkString               | RedisEmptyBulkString          | RedisNullBulkString           | RedisArray                    | RedisNullArray                | RedisArrayItems but len < number                          | RedisArrayItems where len = number | string                                         | +                              | -                             | :                           | $                                              | *                                             | number                                         | 0                                              | -1                                             | crlf                                                      |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  | RedisValue -> · RedisString                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> · RedisError                                |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> · RedisInt                                  |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> · RedisBulkString                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> · RedisEmptyString                          |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> · RedisNullString                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> · RedisArray                                |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisValue -> · RedisNullArray                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisString -> · + string crlf                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisError -> · - string crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisInt -> · : number crlf                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             | clear done                                     |                                               |                                                |                                                |                                                |                                                           |
  | RedisBulkString -> · $ number crlf string crlf            | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         |                                                           |                                    |                                                |                                |                               |                             | shift                                          | clear done                                    |                                                |                                                |                                                |                                                           |
  | RedisEmptyBulkString -> · $ 0 crlf crlf                   | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | reduce to redis value         | error                                                     | error                              | error                                          | clear done                     | clear done                    | clear done                  | ----                                           | shift                                         | error                                          | error                                          | error                                          | error                                                     |
  | RedisNullBulkString -> · $ -1 crlf                        | set done                      | set done                      | set done                      | set done                      | set done                      | set done                      | set done                      | set done                      | quit                                                      | quit                               | quit                                           | shift                          | shift                         | shift                       | RedisBulkString -> $ · number crlf string crlf | ----                                          | quit                                           | quit                                           | quit                                           | quit                                                      |
  | RedisArray -> · * number crlf RedisArrayItems             | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | RedisEmptyBulkString -> $ · 0 crlf crlf        | RedisArray -> * · number crlf RedisArrayItems | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> · * -1 crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                | RedisString -> + · string crlf | RedisError -> - · string crlf | RedisInt -> : · number crlf | RedisNullBulkString -> $ · -1 crlf             | RedisNullArray -> * · -1 crlf                 |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              |                                                | error                          | error                         | error                       | error                                          | error                                         | convert to string                              | convert to string                              | convert to string                              | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | shift                                          | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisString -> + · string crlf                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    | RedisString -> + string · crlf                 |                                |                               |                             |                                                |                                               | RedisString -> + string · crlf                 | RedisString -> + string · crlf                 | RedisString -> + string · crlf                 |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis string                                  |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisString -> + string · crlf                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              |                                                | error                          | error                         | error                       | error                                          | error                                         | convert to string                              | convert to string                              | convert to string                              | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | shift                                          | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisError -> - · string crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    | RedisError -> - string · crlf                  |                                |                               |                             |                                                |                                               | RedisError -> - string · crlf                  | RedisError -> - string · crlf                  | RedisError -> - string · crlf                  |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis error                                   |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisError -> - string · crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         |                                                |                                                |                                                | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisInt -> : · number crlf                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               | RedisInt -> : number · crlf                    | RedisInt -> : number · crlf                    | RedisInt -> : number · crlf                    |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis int                                     |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisInt -> : number · crlf                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         |                                                |                                                |                                                | error                                                     |
  | RedisBulkString -> $ · number crlf string crlf            | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  | RedisEmptyBulkString -> $ · 0 crlf crlf                   | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullBulkString -> $ · -1 crlf                        |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               | RedisBulkString -> $ number · crlf string crlf | RedisEmptyBulkString -> $ 0 · crlf crlf        | RedisNullBulkString -> $ -1 · crlf             |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          |                                                           |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | shift                                                     |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisBulkString -> $ number · crlf string crlf            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisBulkString -> $ number crlf · string crlf            |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              |                                                | error                          | error                         | error                       | error                                          | error                                         | convert to string                              | convert to string                              | convert to string                              | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | shift                                          | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisBulkString -> $ number crlf · string crlf            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    | RedisBulkString -> $ number crlf string · crlf |                                |                               |                             |                                                |                                               | RedisBulkString -> $ number crlf string · crlf | RedisBulkString -> $ number crlf string · crlf | RedisBulkString -> $ number crlf string · crlf |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 5 to redis bulk string                             |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisBulkString -> $ number crlf string · crlf            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          |                                                           |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | shift                                                     |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisEmptyBulkString -> $ 0 · crlf crlf                   |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisEmptyBulkString -> $ 0 crlf · crlf                   |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 4 to redis empty bulk string                       |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisEmptyBulkString -> $ 0 crlf · crlf                   |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis null bulk string                        |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullBulkString -> $ -1 · crlf                        |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | push array length                              | push array length                              |                                                | error                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | shift                                          | shift                                          | shift                                          | quit                                                      |
  | RedisArray -> * · number crlf RedisArrayItems             | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> * · -1 crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               | RedisArray -> * number · crlf RedisArrayItems  | RedisArray -> * number · crlf RedisArrayItems  | RedisNullArray -> * -1 · crlf                  |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | shift                                                     |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | ----                                                      |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArray -> * number crlf · RedisArrayItems             |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArrayItems RedisString          |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArrayItems RedisError           |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArrayItems RedisInt             |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArrayItems RedisBulkString      |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArrayItems RedisEmptyBulkString |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArrayItems RedisNullBulkString  |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArrayItems RedisArray           |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArrayItems RedisNullArray       |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisString                          |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisError                           |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisInt                             |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisBulkString                      |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisEmptyBulkString                 |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisNullBulkString                  |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisArray                           |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisArrayItems -> · RedisNullArray                       |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisString -> · + string crlf                            |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisError -> · - string crlf                             |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisInt -> · : number crlf                               |
  |                                                           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisBulkString -> · $ number crlf string crlf            |
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | RedisEmptyBulkString -> · $ 0 crlf crlf                   |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | RedisNullBulkString -> · $ -1 crlf                        |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | RedisArray -> · * number crlf RedisArrayItems             |
  | RedisArray -> * number · crlf RedisArrayItems             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                | RedisNullArray -> · * -1 crlf                             |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  | RedisArray -> * number crlf · RedisArrayItems             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArrayItems RedisString          |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArrayItems RedisError           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArrayItems RedisInt             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArrayItems RedisBulkString      |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArrayItems RedisEmptyBulkString |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArrayItems RedisNullBulkString  |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArrayItems RedisArray           |                               |                               |                               |                               |                               |                               |                               |                               | shift                                                     |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArrayItems RedisNullArray       |                               |                               |                               |                               |                               |                               |                               |                               | ----                                                      |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisString                          |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems · RedisString          |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisError                           |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems · RedisError           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisInt                             |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems · RedisInt             |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisBulkString                      |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems · RedisBulkString      |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisEmptyBulkString                 |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems · RedisEmptyBulkString |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisNullBulkString                  |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems · RedisNullBulkString  |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisArray                           |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems · RedisArray           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> · RedisNullArray                       |                               |                               |                               |                               |                               |                               |                               |                               | RedisArrayItems -> RedisArrayItems · RedisNullArray       |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisString -> · + string crlf                            |                               |                               |                               |                               |                               |                               |                               |                               | RedisString -> · + string crlf                            |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisError -> · - string crlf                             |                               |                               |                               |                               |                               |                               |                               |                               | RedisError -> · - string crlf                             |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisInt -> · : number crlf                               |                               |                               |                               |                               |                               |                               |                               |                               | RedisInt -> · : number crlf                               |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisBulkString -> · $ number crlf string crlf            |                               |                               |                               |                               |                               |                               |                               |                               | RedisBulkString -> · $ number crlf string crlf            | shift                              |                                                |                                |                               |                             | shift                                          |                                               |                                                |                                                |                                                |                                                           |
  | RedisEmptyBulkString -> · $ 0 crlf crlf                   | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | RedisEmptyBulkString -> · $ 0 crlf crlf                   | reduce 4 to RedisArray             | error                                          |                                |                               |                             | ----                                           | shift                                         | error                                          | error                                          | error                                          | error                                                     |
  | RedisNullBulkString -> · $ -1 crlf                        | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | reduce 1 to redis array items | RedisNullBulkString -> · $ -1 crlf                        | pop array length                   | quit                                           | shift                          | shift                         | shift                       | RedisBulkString -> $ · number crlf string crlf | ----                                          | quit                                           | quit                                           | quit                                           | quit                                                      |
  | RedisArray -> · * number crlf RedisArrayItems             | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | RedisArray -> · * number crlf RedisArrayItems             | ----                               | ----                                           | ----                           | ----                          | ----                        | RedisEmptyBulkString -> $ · 0 crlf crlf        | RedisArray -> * · number crlf RedisArrayItems | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> · * -1 crlf                             |                               |                               |                               |                               |                               |                               |                               |                               | RedisNullArray -> · * -1 crlf                             |                                    |                                                | RedisString -> + · string crlf | RedisError -> - · string crlf | RedisInt -> : · number crlf | RedisNullBulkString -> $ · -1 crlf             | RedisNullArray -> * · -1 crlf                 |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  | RedisArrayItems -> RedisArrayItems · RedisString          |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems · RedisError           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems · RedisInt             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems · RedisBulkString      |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems · RedisEmptyBulkString |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems · RedisNullBulkString  |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems · RedisArray           |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisArrayItems -> RedisArrayItems · RedisNullArray       |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisString -> · + string crlf                            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisError -> · - string crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisInt -> · : number crlf                               |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  | RedisBulkString -> · $ number crlf string crlf            |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             | shift                                          |                                               |                                                |                                                |                                                |                                                           |
  | RedisEmptyBulkString -> · $ 0 crlf crlf                   | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | shift                         | error                                                     | error                              | error                                          |                                |                               |                             | ----                                           | shift                                         | error                                          | error                                          | error                                          | error                                                     |
  | RedisNullBulkString -> · $ -1 crlf                        | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | reduce 2 to redis array items | quit                                                      | quit                               | quit                                           | shift                          | shift                         | shift                       | RedisBulkString -> $ · number crlf string crlf | ----                                          | quit                                           | quit                                           | quit                                           | quit                                                      |
  | RedisArray -> · * number crlf RedisArrayItems             | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | RedisEmptyBulkString -> $ · 0 crlf crlf        | RedisArray -> * · number crlf RedisArrayItems | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> · * -1 crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                | RedisString -> + · string crlf | RedisError -> - · string crlf | RedisInt -> : · number crlf | RedisNullBulkString -> $ · -1 crlf             | RedisNullArray -> * · -1 crlf                 |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
  |                                                           | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                         | error                                                     | error                              | error                                          | error                          | error                         | error                       | error                                          | error                                         | error                                          | error                                          | error                                          | shift                                                     |
  |                                                           | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                          | quit                                                      | quit                               | quit                                           | quit                           | quit                          | quit                        | quit                                           | quit                                          | quit                                           | quit                                           | quit                                           | reduce 3 to redis null array                              |
  |                                                           | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                          | ----                                                      | ----                               | ----                                           | ----                           | ----                          | ----                        | ----                                           | ----                                          | ----                                           | ----                                           | ----                                           | ----                                                      |
  | RedisNullArray -> * -1 · crlf                             |                               |                               |                               |                               |                               |                               |                               |                               |                                                           |                                    |                                                |                                |                               |                             |                                                |                                               |                                                |                                                |                                                |                                                           |
  +-----------------------------------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-------------------------------+-----------------------------------------------------------+------------------------------------+------------------------------------------------+--------------------------------+-------------------------------+-----------------------------+------------------------------------------------+-----------------------------------------------+------------------------------------------------+------------------------------------------------+------------------------------------------------+-----------------------------------------------------------+
#+end_src
*** 数据定义
#+begin_src ponylang :noweb-ref syntax-context
  primitive EOF

  type SyntaxValue is (Signed | RedisValue | List[RedisValue] | EOF)

  class SyntaxContext
      var input: SyntaxValue
      var value: SyntaxValue
      let fsm: SyntaxStateMachine[SyntaxContext]
      var state_stack: List[I32]
      var value_stack: List[SyntaxValue]
      var queue: List[SyntaxValue]
      var err: Bool
      var errmsg: String
      var arrlen: List[USize]
      var done: Bool
      let logger: (Logger[String] | None)

      new create(fsm': SyntaxStateMachine[SyntaxContext], logger': (Logger[String] | None) = None) =>
          input = EOF
          value = EOF
          fsm = fsm'
          state_stack = List[I32]()
          value_stack = List[SyntaxValue]()
          queue = List[SyntaxValue]()
          err = false
          errmsg = ""
          arrlen = List[USize]()
          done = false
          logger = logger'
#+end_src
*** 动作代理
#+begin_src ponylang :noweb-ref syntax-action-delegate
  primitive RedisSyntaxActionDelegate is SyntaxActionDelegate[SyntaxContext]
      fun shift(ctx: SyntaxContext): SyntaxContext =>
          ctx.state_stack.push(ctx.fsm.state)
          ctx.value_stack.push(ctx.input)
          ctx

      fun set_done(ctx: SyntaxContext): SyntaxContext =>
          ctx.done = true
          ctx

      fun my_error(ctx: SyntaxContext): SyntaxContext =>
          ctx.err = true
          ctx.errmsg = "Syntax Error"
          ctx

      fun quit(ctx: SyntaxContext): SyntaxContext =>
          ctx

      fun clear_done(ctx: SyntaxContext): SyntaxContext =>
          ctx.done = false
          ctx

      fun convert_to_string(ctx: SyntaxContext): SyntaxContext =>
          match ctx.input
          | let n: Number => ctx.input = n.string()
          else
              ctx.input = ""
          end
          ctx

      fun reduce_to_redis_value(ctx: SyntaxContext): SyntaxContext =>
          ctx.value = try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          ctx

      fun reduce_3_to_redis_string(ctx: SyntaxContext): SyntaxContext =>
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          let sv = try ctx.value_stack.pop()? else "" end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          ctx.queue.push(sv)
          ctx

      fun reduce_3_to_redis_error(ctx: SyntaxContext): SyntaxContext =>
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          let ev =
              try
                  match ctx.value_stack.pop()?
                  | let s: String => s
                  else
                      ""
                  end
              else
                  ""
              end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          ctx.queue.push(RedisError(ev))
          ctx

      fun reduce_3_to_redis_int(ctx: SyntaxContext): SyntaxContext =>
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          let iv: I64 =
              try
                  match ctx.value_stack.pop()?
                  | let s: String => s.i64()?
                  else
                      0
                  end
              else
                  0
              end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          ctx.queue.push(iv)
          ctx

      fun reduce_5_to_redis_bulk_string(ctx: SyntaxContext): SyntaxContext =>
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          let sv =
              try
                  match ctx.value_stack.pop()?
                  | let s: String => s
                  else
                      ""
                  end
              else
                  ""
              end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          ctx.queue.push(RedisBulkString(sv))
          ctx

      fun reduce_4_to_redis_empty_bulk_string(ctx: SyntaxContext): SyntaxContext =>
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          ctx.queue.push(RedisBulkString(""))
          ctx

      fun reduce_3_to_redis_null_bulk_string(ctx: SyntaxContext): SyntaxContext =>
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          ctx.queue.push(RedisBulkString(None))
          ctx

      fun push_array_length(ctx: SyntaxContext): SyntaxContext =>
          ctx.arrlen.push(match ctx.input | let c: I32 => USize.from[I32](c) else 0 end)
          ctx

      fun reduce_1_to_redis_array_items(ctx: SyntaxContext): SyntaxContext =>
          let item = try ctx.value_stack.pop()? else "" end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          let list = List[RedisValue]()
          ctx.queue.push(list)
          ctx

      fun reduce_4_to_redisarray(ctx: SyntaxContext): SyntaxContext =>
          let items = try ctx.value_stack.pop()? else List[RedisValue] end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          let arr: _RedisArray trn = recover _RedisArray.create() end
          match items
          | let list: List[RedisValue] =>
              for item in list.values() do
                  arr.push(item)
              end
          end
          let array: _RedisArray val = consume arr
          ctx.queue.push(array)
          ctx

      fun pop_array_length(ctx: SyntaxContext): SyntaxContext =>
          try ctx.arrlen.pop()? else 0 end
          ctx

      fun reduce_2_to_redis_array_items(ctx: SyntaxContext): SyntaxContext =>
          let item = try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          let list = try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          match list
          | let lst: List[RedisValue] =>
              match item
              | let s: String => lst.push(s)
              | let i: RedisInteger => lst.push(i)
              | let a: _RedisArray => lst.push(a)
              end
          end
          ctx.queue.push(list)
          ctx

      fun reduce_3_to_redis_null_array(ctx: SyntaxContext): SyntaxContext =>
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          try ctx.state_stack.pop()? else 0 end
          try ctx.value_stack.pop()? else EOF end
          ctx.fsm.state = try ctx.state_stack.pop()? else 0 end
          ctx.queue.push(None)
          ctx
#+end_src
* 接口定义
** 框架
#+begin_src ponylang :noweb-ref api
  trait tag RedisAPI
      <<key-value>>
#+end_src
** 键值相关
*** 框架
#+begin_src ponylang :noweb-ref key-value
  fun tag _exec[A: Any val, C: _RedisValueConverter[A]](cmd: ReadSeq[String]): Promise[A]
  <<get>>
  <<set>>
#+end_src
*** get
#+begin_src ponylang :noweb-ref get
  fun tag get(key: String): Promise[(String | None)] =>
      """Get the value of key"""
      _exec[(String | None), _RedisValue2String](["GET"; key])
#+end_src
*** set
#+begin_src ponylang :noweb-ref set
  fun tag set(key: String, value: String): Promise[(String | None)] =>
      """Get the value of key"""
      _exec[(String | None), _RedisValue2String](["SET"; key; value])
#+end_src
* Actor 实现
** 框架
#+begin_src ponylang :noweb-ref actor
  <<tcp-notify>>

  <<actor-defination>>
#+end_src
** TCP 通知
#+begin_src ponylang :noweb-ref tcp-notify
  class iso _TCPConnectionNotify is TCPConnectionNotify
      let redis: Redis
      let sctx: SyntaxContext
      let sfsm: SyntaxStateMachine[SyntaxContext]
      let lctx: LexerContext
      let lfsm: LexerStateMachine[LexerContext]
      let _logger: (Logger[String] | None)

      new iso create(redis': Redis, logger: (Logger[String] | None)) =>
          redis = redis'
          sfsm = SyntaxStateMachine[SyntaxContext](RedisSyntaxActionDelegate, logger)
          sctx = SyntaxContext(sfsm, logger)
          lfsm = LexerStateMachine[LexerContext](RedisLexerActionDelegate, RedisLexerGuardDelegate, logger)
          lctx = LexerContext(sfsm, sctx, logger)
          _logger = logger

      fun ref connected(conn: TCPConnection ref) =>
          redis._connected(conn)

      fun ref received(
          conn: TCPConnection ref,
          data: Array[U8] iso,
          times: USize)
          : Bool =>
          for ch in (consume data).values() do
              lfsm.input(lctx, ch)
          end
          lfsm.eof(lctx)
          if sctx.done then
              match sctx.value
              | let rv: RedisValue => redis._received(rv)
              end
              false
          else
              true
          end

      fun ref connect_failed(conn: TCPConnection ref): None val =>
          redis._connect_failed()

      fun ref closed(conn: TCPConnection ref): None val =>
          redis._closed()

      fun ref _log(level: LogLevel, message: String val, loc: SourceLoc = __loc) =>
          match _logger
          | let l: Logger[String] => l(level) and l.log(message, loc)
          end
#+end_src
** actor
#+begin_src ponylang :noweb-ref actor-defination
  actor Redis is RedisAPI

      let _auth: TCPConnectionAuth
      let _logger: (Logger[String] | None)
      var _conn: (TCPConnection | None) = None

      embed outgoing: Array[ByteSeqIter] = Array[ByteSeqIter]
      embed promises: List[Promise[RedisValue]] = List[Promise[RedisValue]]

      new create(auth: TCPConnectionAuth, logger: (Logger[String] | None) = None) =>
          _auth = auth
          _logger = logger

      be connect(host': String, port': String) =>
          TCPConnection(_auth, _TCPConnectionNotify(this, _logger), host', port')

      be dispose() =>
          match _conn
          | let conn: TCPConnection => conn.dispose()
          end

      be _connected(conn: TCPConnection) =>
          try
              conn.writev(outgoing.shift()?)
          end
          _conn = conn

      be _connect_failed() =>
          _conn = None

      be _closed() =>
          _conn = None

      be _received(r: RedisValue) =>
          try
              promises.shift()?(r)
          end
          if outgoing.size() > 0 then
              try
                  match _conn
                  | let conn: TCPConnection => conn.writev(outgoing.shift()?)
                  end
              end
          end

      be _send(m: ByteSeqIter, p: Promise[RedisValue]) =>
          match _conn
          | let conn: TCPConnection => conn.writev(m)
          else
              outgoing.push(m)
          end
          promises.push(p)

      fun tag _exec[A: Any val, C: _RedisValueConverter[A]](cmd: ReadSeq[String]): Promise[A] =>
          let p = Promise[RedisValue]
          _send(_Encode(cmd), p)
          p.next[A]({(v: RedisValue): A => C(v)})

      fun ref _log(level: LogLevel, message: String val, loc: SourceLoc = __loc) =>
          match _logger
          | let l: Logger[String] => l(level) and l.log(message, loc)
          end
#+end_src
* 辅助方法
** 框架
#+begin_src pony :noweb-ref utilities
  <<serializer>>

  <<converter>>
#+end_src
** serializer
#+begin_src ponylang :noweb-ref serializer
  primitive _Encode
      fun apply(input: ReadSeq[String]): Array[String] val =>
          let size = 3 + (5 * input.size())
          let output = recover trn Array[String](size) end

          output.push("*")
          output.push(input.size().string())
          output.push("\r\n")

          for str in input.values() do
              output.push("$")
              output.push(str.size().string())
              output.push("\r\n")
              output.push(str)
              output.push("\r\n")
          end

          output
#+end_src
** 转化器
#+begin_src ponylang :noweb-ref converter
  trait val _RedisValueConverter[A: Any val]
    new val create()
    fun val apply(value: RedisValue): A

  primitive _RedisValue2String is _RedisValueConverter[(String | None)]
      fun apply(value: RedisValue): (String | None) =>
          match value
          | let s: RedisString => s
          | let bs: RedisBulkString => bs.string()
          else
              None
          end
#+end_src
